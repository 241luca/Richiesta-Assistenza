# ================================
# GitHub Actions - Deploy Automatico
# Richiesta Assistenza v5.1
# ================================

name: ğŸš€ Deploy Production

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'DOCUMENTAZIONE/**'
      - '*.md'
      - '.gitignore'
  
  # Deploy manuale
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy anche senza cambiamenti'
        required: false
        default: 'false'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_FRONTEND: ${{ github.repository }}-frontend
  IMAGE_NAME_BACKEND: ${{ github.repository }}-backend

jobs:
  # ==========================================
  # ğŸ” CONTROLLI QUALITÃ€
  # ==========================================
  quality-checks:
    name: ğŸ” Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci
          cd backend && npm ci

      - name: ğŸ§ª Run tests
        run: |
          npm run test
          cd backend && npm test

      - name: ğŸ” Lint check
        run: |
          npm run lint
          cd backend && npm run lint

  # ==========================================
  # ğŸ”¨ BUILD & PUSH DOCKER IMAGES
  # ==========================================
  build-and-push:
    name: ğŸ”¨ Build & Push Images
    runs-on: ubuntu-latest
    needs: quality-checks
    permissions:
      contents: read
      packages: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ==========================================
      # ğŸ¨ BUILD FRONTEND
      # ==========================================
      - name: ğŸ¨ Build Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:v${{ github.run_number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ==========================================  
      # ğŸ’» BUILD BACKEND
      # ==========================================
      - name: ğŸ’» Build Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:v${{ github.run_number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================
  # ğŸš€ DEPLOY SU VPS
  # ==========================================
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸš€ Starting deployment..."
            
            # Vai nella cartella progetto
            cd /opt/richiesta-assistenza
            
            # Pull latest code
            git pull origin main
            
            # Login al registry
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Pull nuove immagini
            docker compose -f docker-compose.production.yml pull
            
            # Backup database prima dell'aggiornamento
            echo "ğŸ“¦ Creating database backup..."
            docker exec richiesta-assistenza-db pg_dump -U postgres richiesta_assistenza > backup/pre-deploy-$(date +%Y%m%d-%H%M%S).sql
            
            # Deploy con zero downtime
            echo "ğŸ”„ Deploying with zero downtime..."
            docker compose -f docker-compose.production.yml up -d --no-deps backend
            sleep 10
            docker compose -f docker-compose.production.yml up -d --no-deps frontend
            sleep 5
            
            # Verifica che tutto funzioni
            echo "âœ… Testing deployment..."
            curl -f https://richiestaassistenza.it/api/health || exit 1
            curl -f https://richiestaassistenza.it/ || exit 1
            
            # Pulizia immagini vecchie
            docker image prune -f
            
            echo "ğŸ‰ Deployment completed successfully!"

      # ==========================================
      # ğŸ“§ NOTIFICA DISCORD/SLACK (Opzionale)
      # ==========================================
      - name: ğŸ“§ Notify Success
        if: success()
        run: |
          echo "ğŸ‰ Deploy SUCCESSFUL to https://richiestaassistenza.it"
          echo "ğŸ“¦ Frontend: ghcr.io/${{ env.IMAGE_NAME_FRONTEND }}:v${{ github.run_number }}"
          echo "ğŸ’» Backend: ghcr.io/${{ env.IMAGE_NAME_BACKEND }}:v${{ github.run_number }}"

      - name: ğŸš¨ Notify Failure  
        if: failure()
        run: |
          echo "âŒ Deploy FAILED!"
          echo "ğŸ“§ Check logs and fix issues"
