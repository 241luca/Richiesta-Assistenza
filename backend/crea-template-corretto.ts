import { PrismaClient } from '@prisma/client'
import { v4 as uuidv4 } from 'uuid'

const prisma = new PrismaClient()

async function creaTemplateCorretto() {
  console.log('\nüìã CREAZIONE TEMPLATE NOTIFICHE CON CAMPO CODE\n')
  console.log('='.repeat(60))
  
  try {
    // RECUPERA CANALI
    const emailChannel = await prisma.notificationChannel.findFirst({ where: { code: 'email' } })
    const wsChannel = await prisma.notificationChannel.findFirst({ where: { code: 'websocket' } })
    const smsChannel = await prisma.notificationChannel.findFirst({ where: { code: 'sms' } })
    
    if (!emailChannel) {
      console.log('‚ùå Canale email non trovato!')
      return
    }
    
    // TEMPLATE CON CAMPO CODE OBBLIGATORIO
    const templates = [
      // AUTH
      { code: 'welcome_user', name: 'Benvenuto nuovo utente', channelId: emailChannel.id, 
        subject: 'üéâ Benvenuto in Richiesta Assistenza!', 
        bodyText: 'Benvenuto {{fullName}}! Verifica email: {{verificationUrl}}' },
      
      { code: 'user_deleted', name: 'Cancellazione utente', channelId: emailChannel.id,
        subject: 'Account cancellato', 
        bodyText: 'Il tuo account √® stato cancellato. Arrivederci {{fullName}}.' },
      
      { code: 'password_reset', name: 'Reset password', channelId: emailChannel.id,
        subject: 'üîê Reset Password Richiesto', 
        bodyText: 'Reset password: {{resetUrl}}' },
      
      { code: 'email_verification', name: 'Verifica email', channelId: emailChannel.id,
        subject: 'üìß Verifica il tuo indirizzo email', 
        bodyText: 'Verifica email: {{verificationUrl}}' },
      
      // REQUEST  
      { code: 'request_created_client', name: 'Nuova richiesta (cliente)', channelId: emailChannel.id,
        subject: '‚úÖ Richiesta #{{requestId}} creata', 
        bodyText: 'Richiesta {{requestTitle}} creata. ID: #{{requestId}}' },
      
      { code: 'request_created_client_ws', name: 'Nuova richiesta (cliente)', channelId: wsChannel?.id,
        subject: '', bodyText: 'Richiesta creata: {{requestTitle}}' },
      
      { code: 'request_modified_client', name: 'Modifica richiesta (cliente)', channelId: emailChannel.id,
        subject: 'üìù Richiesta modificata', 
        bodyText: 'Richiesta {{requestTitle}} modificata' },
      
      { code: 'request_modified_professional', name: 'Modifica richiesta (prof)', channelId: emailChannel.id,
        subject: 'üìù Cliente ha modificato richiesta', 
        bodyText: 'Cliente ha modificato: {{requestTitle}}' },
      
      { code: 'request_closed_client', name: 'Chiusura richiesta (cliente)', channelId: emailChannel.id,
        subject: '‚úÖ Servizio completato', 
        bodyText: 'Servizio {{requestTitle}} completato!' },
      
      { code: 'request_closed_professional', name: 'Chiusura richiesta (prof)', channelId: emailChannel.id,
        subject: '‚úÖ Richiesta chiusa', 
        bodyText: 'Richiesta {{requestTitle}} chiusa. ‚Ç¨{{totalAmount}}' },
      
      { code: 'request_assigned_client', name: 'Assegnazione professionista', channelId: emailChannel.id,
        subject: 'üë∑ Professionista assegnato', 
        bodyText: '{{professionalName}} assegnato. Tel: {{professionalPhone}}' },
      
      { code: 'request_assigned_client_sms', name: 'Assegnazione professionista', channelId: smsChannel?.id,
        subject: '', 
        bodyText: 'Professionista {{professionalName}} assegnato. Tel: {{professionalPhone}}' },
      
      { code: 'request_assigned_professional', name: 'Nuova richiesta assegnata', channelId: emailChannel.id,
        subject: 'üîî Nuova richiesta: {{requestTitle}}', 
        bodyText: 'Nuova richiesta da {{clientName}} - {{clientPhone}}' },
      
      { code: 'request_assigned_professional_sms', name: 'Nuova richiesta', channelId: smsChannel?.id,
        subject: '', 
        bodyText: 'Nuova richiesta: {{requestTitle}}. Cliente: {{clientPhone}}' },
      
      { code: 'request_status_changed', name: 'Cambio stato richiesta', channelId: wsChannel?.id,
        subject: '', 
        bodyText: 'Richiesta {{requestTitle}} ora: {{newStatus}}' },
      
      // QUOTE
      { code: 'quote_received', name: 'Nuovo preventivo ricevuto', channelId: emailChannel.id,
        subject: 'üí∞ Nuovo preventivo: ‚Ç¨{{quoteAmount}}', 
        bodyText: 'Preventivo da {{professionalName}}: ‚Ç¨{{quoteAmount}}' },
      
      { code: 'quote_received_ws', name: 'Nuovo preventivo', channelId: wsChannel?.id,
        subject: '', 
        bodyText: 'Nuovo preventivo: ‚Ç¨{{quoteAmount}}' },
      
      { code: 'quote_modified', name: 'Preventivo modificato', channelId: emailChannel.id,
        subject: 'üìù Preventivo modificato', 
        bodyText: 'Preventivo modificato. Nuovo: ‚Ç¨{{newAmount}}' },
      
      { code: 'quote_accepted_professional', name: 'Preventivo accettato', channelId: emailChannel.id,
        subject: '‚úÖ Preventivo accettato!', 
        bodyText: 'Preventivo accettato! Contatta {{clientName}}: {{clientPhone}}' },
      
      { code: 'quote_accepted_professional_sms', name: 'Preventivo accettato', channelId: smsChannel?.id,
        subject: '', 
        bodyText: '‚úÖ Preventivo accettato! Tel: {{clientPhone}}' },
      
      { code: 'quote_rejected_professional', name: 'Preventivo rifiutato', channelId: emailChannel.id,
        subject: '‚ùå Preventivo rifiutato', 
        bodyText: 'Preventivo rifiutato. Motivo: {{rejectionReason}}' },
      
      // CHAT
      { code: 'chat_message_client', name: 'Nuovo messaggio (cliente)', channelId: wsChannel?.id,
        subject: '', 
        bodyText: '{{professionalName}}: {{messagePreview}}' },
      
      { code: 'chat_message_client_email', name: 'Nuovo messaggio', channelId: emailChannel.id,
        subject: 'üí¨ Messaggio da {{professionalName}}', 
        bodyText: 'Messaggio: {{messagePreview}}' },
      
      { code: 'chat_message_professional', name: 'Nuovo messaggio (prof)', channelId: wsChannel?.id,
        subject: '', 
        bodyText: '{{clientName}}: {{messagePreview}}' },
      
      { code: 'chat_message_professional_email', name: 'Nuovo messaggio', channelId: emailChannel.id,
        subject: 'üí¨ Messaggio da {{clientName}}', 
        bodyText: 'Messaggio: {{messagePreview}}' },
      
      // PROFESSIONAL
      { code: 'skill_added', name: 'Nuova competenza aggiunta', channelId: emailChannel.id,
        subject: '‚úÖ Competenza aggiunta: {{skillName}}', 
        bodyText: 'Competenza {{skillName}} aggiunta al profilo' },
      
      { code: 'skill_revoked', name: 'Competenza revocata', channelId: emailChannel.id,
        subject: '‚ùå Competenza rimossa: {{skillName}}', 
        bodyText: 'Competenza {{skillName}} rimossa' },
      
      // PAYMENT
      { code: 'payment_success', name: 'Pagamento completato', channelId: emailChannel.id,
        subject: '‚úÖ Pagamento ‚Ç¨{{amount}} ricevuto', 
        bodyText: 'Pagamento ‚Ç¨{{amount}} ricevuto per {{requestTitle}}' },
      
      { code: 'payment_failed', name: 'Pagamento fallito', channelId: emailChannel.id,
        subject: '‚ùå Pagamento non riuscito', 
        bodyText: 'Pagamento ‚Ç¨{{amount}} fallito. Motivo: {{failureReason}}' },
      
      { code: 'deposit_required', name: 'Richiesta deposito', channelId: emailChannel.id,
        subject: 'üí≥ Deposito richiesto: ‚Ç¨{{depositAmount}}', 
        bodyText: 'Deposito ‚Ç¨{{depositAmount}} richiesto. Scadenza: {{depositDeadline}}' }
    ]
    
    // CREA I TEMPLATE
    console.log('üìù Creazione template...\n')
    let created = 0
    let skipped = 0
    
    for (const tmpl of templates) {
      if (!tmpl.channelId) continue
      
      try {
        await prisma.notificationTemplate.create({
          data: {
            id: uuidv4(),
            code: tmpl.code, // CAMPO CODE OBBLIGATORIO!
            type: tmpl.code.replace(/_/g, '-'), 
            name: tmpl.name,
            channelId: tmpl.channelId,
            subject: tmpl.subject || '',
            bodyHtml: '', // Aggiungi HTML completo se vuoi
            bodyText: tmpl.bodyText || '',
            variables: extractVars(tmpl.subject + ' ' + tmpl.bodyText),
            isActive: true,
            createdAt: new Date(),
            updatedAt: new Date()
          }
        })
        
        console.log(`‚úÖ ${tmpl.code}`)
        created++
        
      } catch (error: any) {
        if (error.code === 'P2002') {
          console.log(`‚ö†Ô∏è  ${tmpl.code} gi√† esistente`)
          skipped++
        } else {
          console.log(`‚ùå Errore ${tmpl.code}:`, error.message)
        }
      }
    }
    
    // VERIFICA FINALE
    console.log('\n' + '='.repeat(60))
    console.log('üìä REPORT FINALE')
    console.log('='.repeat(60))
    
    const totalTemplates = await prisma.notificationTemplate.count()
    
    console.log(`
‚úÖ Template creati: ${created}
‚ö†Ô∏è  Template saltati: ${skipped}  
üìä Template totali nel database: ${totalTemplates}

üìã LISTA TEMPLATE DISPONIBILI:

**AUTH**
‚Ä¢ welcome_user - Benvenuto nuovo utente
‚Ä¢ user_deleted - Cancellazione utente  
‚Ä¢ password_reset - Reset password
‚Ä¢ email_verification - Verifica email

**REQUEST**
‚Ä¢ request_created_client - Nuova richiesta (cliente)
‚Ä¢ request_modified_client - Modifica richiesta (cliente)
‚Ä¢ request_modified_professional - Modifica richiesta (professionista)
‚Ä¢ request_closed_client - Chiusura richiesta (cliente)
‚Ä¢ request_closed_professional - Chiusura richiesta (professionista)
‚Ä¢ request_assigned_client - Assegnazione professionista
‚Ä¢ request_assigned_professional - Nuova richiesta assegnata
‚Ä¢ request_status_changed - Cambio stato richiesta

**QUOTE**
‚Ä¢ quote_received - Nuovo preventivo ricevuto
‚Ä¢ quote_modified - Preventivo modificato
‚Ä¢ quote_accepted_professional - Preventivo accettato
‚Ä¢ quote_rejected_professional - Preventivo rifiutato

**CHAT**
‚Ä¢ chat_message_client - Nuovo messaggio (cliente)
‚Ä¢ chat_message_professional - Nuovo messaggio (professionista)

**PROFESSIONAL**
‚Ä¢ skill_added - Nuova competenza aggiunta
‚Ä¢ skill_revoked - Competenza revocata

**PAYMENT**
‚Ä¢ payment_success - Pagamento completato
‚Ä¢ payment_failed - Pagamento fallito
‚Ä¢ deposit_required - Richiesta deposito

üéâ SISTEMA NOTIFICHE CONFIGURATO!
`)
    
  } catch (error) {
    console.error('‚ùå Errore:', error)
  } finally {
    await prisma.$disconnect()
  }
}

function extractVars(text: string): string[] {
  const matches = text.match(/{{(\w+)}}/g) || []
  return [...new Set(matches.map(m => m.replace(/[{}]/g, '')))]
}

// Esegui
creaTemplateCorretto()
